<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Server Diagnostics</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
</head>
<body onload="requestMetrics()">
<style>
    table {
        border-collapse: collapse;
    }

    td, th {
        border: 1px solid black;
        padding: 0.5rem;
    }

    table.side_headings td, table.side_headings th {
        text-align: left;
    }

    th {
        background: lightblue;
        font-weight: bold;
    }
</style>
<script>
    function requestMetrics() {
        // JQuery request to "/metrics"
        $.getJSON(
            "/metrics"
        ).done(function (json) {
            fillMetrics(json);
        });
    }

    function attribute_id_string(attribute_id) {
        switch (attribute_id) {
            case 1:
                return "NodeId";
            case 2:
                return "NodeClass";
            case 3:
                return "BrowseName";
            case 4:
                return "DisplayName";
            case 5:
                return "Description";
            case 6:
                return "WriteMask";
            case 7:
                return "UserWriteMask";
            case 8:
                return "IsAbstract";
            case 9:
                return "Symmetric";
            case 10:
                return "InverseName";
            case 11:
                return "ContainsNoLoops";
            case 12:
                return "EventNotifier";
            case 13:
                return "Value";
            case 14:
                return "DataType";
            case 15:
                return "ValueRank";
            case 16:
                return "ArrayDimensions";
            case 17:
                return "AccessLevel";
            case 18:
                return "UserAccessLevel";
            case 19:
                return "MinimumSamplingInterval";
            case 20:
                return "Historizing";
            case 21:
                return "Executable";
            case 22:
                return "UserExecutable";
            default:
                return "Unknown";
        }
    }

    function node_id_str(node_id) {
        const identifier = node_id.identifier;
        if (identifier["String"]) {
            return `ns=${node_id.namespace};s=${identifier["String"].value}`;
        }
        else if (identifier["Numeric"]) {
            return `ns=${node_id.namespace};i=${identifier["Numeric"]}`;
        }
        else if (identifier["Guid"]) {
            return `ns=${node_id.namespace};g=${identifier["Guid"].value}`;
        }
        else if (identifier["ByteString"]) {
            return `ns=${node_id.namespace};b=......`;
        }
        else {
            return `Invalid node id`
        }
    }

    function fillMetrics(json) {
        let html = `<h1 class='server'>Server</h1>`;

        html += dump_server(json["config"], json["server"]);

        // diagnostic summary
        html += dump_diagnostics(json["diagnostics"]);

        // Sessions
        const connections = json["connections"];
        html += "<h1 class='connections'>Client connections</h1>";
        if (connections.length === 0) {
            html += "<p>No connections</p>";
        }
        else {
            connections.forEach(function (connection) {
                    html += dump_connection(connection);

                    // Subscriptions
                    const subscriptions = connection["subscriptions"];
                    if (subscriptions.length === 0) {
                        html += `<p>No subscriptions</p>`;
                    }
                    else {
                        subscriptions.forEach(function (subscription) {
                            html += dump_subscription(subscription);
                            var monitored_items = subscription.monitored_items;
                            if (monitored_items.length === 0) {
                                html += "<p>No monitored items</p>";
                            }
                            else {
                                Object.keys(monitored_items).forEach(function (key) {
                                    const item = monitored_items[key];
                                    html += dump_monitored_item(item);
                                });
                            }
                        });
                    }
                }
            );
        }
        $("#metrics").html(html);
    }

    function dump_server(config, server) {
        return `<table class="side_headings">
<tr><th>Server name</th><td>${config["application_name"]}</td></tr>
<tr><th>Server URI</th><td>${config["application_uri"]}</td></tr>
<tr><th>Start Time</th><td>${new Date(server["start_time"]).toString()}</td></tr>
<tr><th>Uptime (MS)</th><td>${server["uptime_ms"]}</td></tr>
</table>
`;
    }

    function dump_connection(connection) {
        `<h2>Client${connection["id"]}</h2>
<table class="side_headings">
<tr><th>Client address</th><td>${connection["client_address"]}</td></tr>
<tr><th>Transport state</th><td>${connection["transport_state"]}</td></tr>
<tr><th>Session activated</th><td>${connection["session_activated"]}</td></tr>
<tr><th>Session terminated</th><td>${connection["session_terminated"]}</td></tr>
<tr><th>Session terminated at</th><td>${connection["session_terminated_at"]}</td></tr>
</table>`;
    }

    function dump_subscription(subscription) {
        return `<h2 class='subscriptions'>Subscriptions</h2>
<h3>Subscription ${subscription.subscription_id}</h3>
<table class="side_headings">
<tr><th>Priority</th><td>${subscription.priority}</td></tr>
<tr><th>Publishing enabled</th><td>${subscription.publishing_enabled}</td></tr>
<tr><th>Publishing interval</th><td>${subscription.publishing_interval}ms</td></tr>
<tr><th>Last Timer Expiration</th><td>${subscription.last_timer_expired_time}</td></tr>
</table>`;
    }

    function dump_monitored_item(item) {
        return `<h4 class='monitoreditems'>Item ${item.monitored_item_id}</h4>
<table class="side_headings">
<tr><th>Item to monitor</th><td>${node_id_str(item.item_to_monitor.node_id)} / ${attribute_id_string(item.item_to_monitor.attribute_id)}</td></tr>
<tr><th>Monitoring mode</th><td>${item.monitoring_mode}</td></tr>
<tr><th>Client handle</th><td>${item.client_handle}</td></tr>
<tr><th>Filter</th><td>${item.filter}</td></tr>
<tr><th>Sampling interval</th><td>${item.sampling_interval}ms</td></tr>
<tr><th>Discard Oldest</th><td>${item.discard_oldest}</td></tr>
<tr><th>Queue Size</th><td>${item.queue_size}</td></tr>
<tr><th>Timestamps to return</th><td>${item.timestamps_to_return}</td></tr>
<tr><th>Last Sample Time</th><td>${item.last_sample_time}</td></tr>
<tr><th>Last Value</th><td>${JSON.stringify(item.last_data_value)}</td></tr>
</table>`;
    }

    function dump_diagnostics(diagnostics) {
        const diagnostics_summary = diagnostics["server_diagnostics_summary"];
        return `<h2 class='diagnostic_summary'>Diagnostic Summary</h2>
<table>
    <thead>
    <tr></tr>
    <tr>
        <th colspan="6">Sessions</th>
        <th colspan="3">Subscriptions</th>
        <th colspan="2">Requests</th>
    </tr>
    <tr>
        <!-- Sesssions -->
        <th>Current</th>
        <th>Cumulative</th>
        <th>Security Rejected</th>
        <th>Rejected</th>
        <th>Timeouts</th>
        <th>Aborts</th>
        <!-- Subscriptions -->
        <th>Current</th>
        <th>Cumulative</th>
        <th>Publishing Intervals</th>
        <!-- Requests -->
        <th>Security Rejected</th>
        <th>Rejected</th>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td>${diagnostics_summary["current_session_count"]}</td>
        <td>${diagnostics_summary["cumulated_session_count"]}</td>
        <td>${diagnostics_summary["security_rejected_session_count"]}</td>
        <td>${diagnostics_summary["rejected_session_count"]}</td>
        <td>${diagnostics_summary["session_timeout_count"]}</td>
        <td>${diagnostics_summary["session_abort_count"]}</td>
        <td>${diagnostics_summary["current_subscription_count"]}</td>
        <td>${diagnostics_summary["cumulated_subscription_count"]}</td>
        <td>${diagnostics_summary["publishing_interval_count"]}</td>
        <td>${diagnostics_summary["security_rejected_requests_count"]}</td>
        <td>${diagnostics_summary["rejected_requests_count"]}</td>
    </tr>
    </tbody>
</table>
`;
    }

</script>

<div><span><a href="#" onclick="requestMetrics()">Reload</a></span></div>

<div id="metrics"><span>Please wait...</span></div>

<div><span><a href="#" onclick="requestMetrics()">Reload</a></span></div>

</body>
</html>
