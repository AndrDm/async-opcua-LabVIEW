<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Server Diagnostics</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
</head>
<body onload="requestMetrics()">
<style>
</style>
<script>
    function requestMetrics() {
        // JQuery request to "/metrics"
        $.getJSON(
            "/metrics"
        ).done(function (json) {
            fillMetrics(json);
        });
    }

    function fillMetrics(json) {
        var html = "";

        html += "<h1>Server</h1>";

        var server = json["server"];
        var config = json["config"];

        html += "<table>";
        html += "<tr><td>Server name:</td><td>" + config["application_name"] + "</td></tr>";
        html += "<tr><td>Server URI:</td><td>" + config["application_uri"] + "</td></tr>";
        html += "<tr><td>Start Time</td><td>" + new Date(server["start_time"]).toString() + "</td></tr>";
        html += "<tr><td>Uptime (MS)</td><td>" + server["uptime_ms"] + "</td></tr>";
        // ip address etc.
        html += "</table>";

        // Sessions
        var connections = json["connections"];
        html += "<h1>Client connections</h1>";
        if (connections.length === 0) {
            html += "<p>No connections</p>";
        }
        else {
            connections.forEach(function (connection) {
                html += "<h2>Client " + connection["id"] + "</h2>";
                html += "<table>";
                html += "<tr><td>Client address:</td><td>" + connection["client_address"] + "</td></tr>";
                html += "<tr><td>Transport state:</td><td>" + connection["transport_state"] + "</td></tr>";
                html += "<tr><td>Session activated:</td><td>" + connection["session_activated"] + "</td></tr>";
                html += "<tr><td>Session terminated:</td><td>" + connection["session_terminated"] + "</td></tr>";
                html += "<tr><td>Session terminated at:</td><td>" + connection["session_terminated_at"] + "</td></tr>";
                html += "</table>";

                // Subscriptions
                var subscriptions = connection["subscriptions"];
                if (subscriptions.length === 0) {
                    html += "<p>No subscriptions</p>";
                }
                else {
                    subscriptions.forEach(function (subscription) {
                        html += "<h2>Subscriptions</h2>";
                        html += "<h3>Subscription " + subscription.subscription_id + "</h3>";
                        html += "<table>";
                        html += "<tr><td>Priority:</td><td>" + subscription.priority + "</td></tr>";
                        html += "<tr><td>Publishing enabled:</td><td>" + subscription.publishing_enabled + "</td></tr>";
                        html += "<tr><td>Publishing interval:</td><td>" + subscription.publishing_interval + "ms</td></tr>";
                        html += "<tr><td>Last Timer Expiration:</td><td>" + subscription.last_timer_expired_time + "</td></tr>";
                        html += "</table>";

                        var monitored_items = subscription.monitored_items;
                        if (monitored_items.length === 0) {
                            html += "<p>No monitored items</p>";
                        }
                        else {
                            Object.keys(monitored_items).forEach(function (key) {
                                var item = monitored_items[key];
                                html += "<h4>Item " + item.monitored_item_id + "</h4>";
                                html += "<table>";
                                html += "<tr><td>Item to monitor:</td><td>" + JSON.stringify(item.item_to_monitor) + "</td></tr>";
                                html += "<tr><td>Monitoring mode:</td><td>" + item.monitoring_mode + "</td></tr>";
                                html += "<tr><td>Client handle:</td><td>" + item.client_handle + "</td></tr>";
                                html += "<tr><td>Filter:</td><td>" + item.filter + "</td></tr>";
                                html += "<tr><td>Sampling interval:</td><td>" + item.sampling_interval + "ms</td></tr>";
                                html += "<tr><td>Discard Oldest:</td><td>" + item.discard_oldest + "</td></tr>";
                                html += "<tr><td>Queue Size:</td><td>" + item.queue_size + "</td></tr>";
                                html += "<tr><td>Timestamps to return:</td><td>" + item.timestamps_to_return + "</td></tr>";
                                html += "<tr><td>Last Sample Time:</td><td>" + item.last_sample_time + "</td></tr>";
                                html += "<tr><td>Last Value:</td><td>" + JSON.stringify(item.last_data_value) + "</td></tr>";
                                html += "</table>";
                            });
                        }
                    });
                }
            });
        }
        $("#metrics").html(html);
    }
</script>

<div><span><a href="#" onclick="requestMetrics()">Reload</a></span></div>

<div id="metrics"><span>Please wait...</span></div>

<div><span><a href="#" onclick="requestMetrics()">Reload</a></span></div>

</body>
</html>
