<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Server Diagnostics</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
</head>
<body onload="requestMetrics()">
<style>
</style>
<script>
    function requestMetrics() {
        // JQuery request to "/metrics"
        $.getJSON(
            "/metrics"
        ).done(function (json) {
            fillMetrics(json);
        });
    }

    function attribute_id_string(attribute_id) {
        switch (attribute_id) {
            case 1:
                return "NodeId";
            case 2:
                return "NodeClass";
            case 3:
                return "BrowseName";
            case 4:
                return "DisplayName";
            case 5:
                return "Description";
            case 6:
                return "WriteMask";
            case 7:
                return "UserWriteMask";
            case 8:
                return "IsAbstract";
            case 9:
                return "Symmetric";
            case 10:
                return "InverseName";
            case 11:
                return "ContainsNoLoops";
            case 12:
                return "EventNotifier";
            case 13:
                return "Value";
            case 14:
                return "DataType";
            case 15:
                return "ValueRank";
            case 16:
                return "ArrayDimensions";
            case 17:
                return "AccessLevel";
            case 18:
                return "UserAccessLevel";
            case 19:
                return "MinimumSamplingInterval";
            case 20:
                return "Historizing";
            case 21:
                return "Executable";
            case 22:
                return "UserExecutable";
            default:
                return "Unknown";
        }
    }

    function node_id_str(node_id) {
        var identifier = node_id.identifier;
        if (identifier["String"]) {
            return `ns=${node_id.namespace};s=${identifier["String"].value}`;
        }
        else if (identifier["Numeric"]) {
            return `ns=${node_id.namespace};i=${identifier["Numeric"]}`;
        }
        else if (identifier["Guid"]) {
            return `ns=${node_id.namespace};g=${identifier["Guid"].value}`;
        }
        else if (identifier["ByteString"]) {
            return `ns=${node_id.namespace};b=......`;
        }
        else {
            return `Invalid node id`
        }
    }

    function fillMetrics(json) {
        var html = "";

        html += `<h1 class='server'>Server</h1>`;

        var server = json["server"];
        var config = json["config"];

        html += `<table>
<tr><td>Server name:</td><td>${config["application_name"]}</td></tr>
<tr><td>Server URI:</td><td>${config["application_uri"]}</td></tr>
<tr><td>Start Time</td><td>${new Date(server["start_time"]).toString()}</td></tr>
<tr><td>Uptime (MS)</td><td>${server["uptime_ms"]}</td></tr>
</table>
`;
        // ip address etc.

        // Sessions
        var connections = json["connections"];
        html += "<h1 class='connections'>Client connections</h1>";
        if (connections.length === 0) {
            html += "<p>No connections</p>";
        }
        else {
            connections.forEach(function (connection) {
                html += `<h2>Client${connection["id"]}</h2>
<table>
<tr><td>Client address:</td><td>${connection["client_address"]}</td></tr>
<tr><td>Transport state:</td><td>${connection["transport_state"]}</td></tr>
<tr><td>Session activated:</td><td>${connection["session_activated"]}</td></tr>
<tr><td>Session terminated:</td><td>${connection["session_terminated"]}</td></tr>
<tr><td>Session terminated at:</td><td>${connection["session_terminated_at"]}</td></tr>
</table>`;

                // Subscriptions
                var subscriptions = connection["subscriptions"];
                if (subscriptions.length === 0) {
                    html += "<p>No subscriptions</p>";
                }
                else {
                    subscriptions.forEach(function (subscription) {
                        html += `<h2 class='subscriptions'>Subscriptions</h2>
<h3>Subscription ${subscription.subscription_id}</h3>
<table>
<tr><td>Priority:</td><td>${subscription.priority}</td></tr>
<tr><td>Publishing enabled:</td><td>${subscription.publishing_enabled}</td></tr>
<tr><td>Publishing interval:</td><td>${subscription.publishing_interval}ms</td></tr>
<tr><td>Last Timer Expiration:</td><td>${subscription.last_timer_expired_time}</td></tr>
</table>`;

                        var monitored_items = subscription.monitored_items;
                        if (monitored_items.length === 0) {
                            html += "<p>No monitored items</p>";
                        }
                        else {
                            Object.keys(monitored_items).forEach(function (key) {
                                var item = monitored_items[key];
                                html += `<h4 class='monitoreditems'>Item ${item.monitored_item_id}</h4>
<table>
<tr><td>Item to monitor:</td><td>${node_id_str(item.item_to_monitor.node_id)} / ${attribute_id_string(item.item_to_monitor.attribute_id)}</td></tr>
<tr><td>Monitoring mode:</td><td>${item.monitoring_mode}</td></tr>
<tr><td>Client handle:</td><td>${item.client_handle}</td></tr>
<tr><td>Filter:</td><td>${item.filter}</td></tr>
<tr><td>Sampling interval:</td><td>${item.sampling_interval}ms</td></tr>
<tr><td>Discard Oldest:</td><td>${item.discard_oldest}</td></tr>
<tr><td>Queue Size:</td><td>${item.queue_size}</td></tr>
<tr><td>Timestamps to return:</td><td>${item.timestamps_to_return}</td></tr>
<tr><td>Last Sample Time:</td><td>${item.last_sample_time}</td></tr>
<tr><td>Last Value:</td><td>${JSON.stringify(item.last_data_value)}</td></tr>
</table>`;
                            });
                        }
                    });
                }
            });
        }
        $("#metrics").html(html);
    }
</script>

<div><span><a href="#" onclick="requestMetrics()">Reload</a></span></div>

<div id="metrics"><span>Please wait...</span></div>

<div><span><a href="#" onclick="requestMetrics()">Reload</a></span></div>

</body>
</html>
